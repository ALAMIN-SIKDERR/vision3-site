<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision 3.0 — Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#071226;color:#e6eef8;padding:18px}
    .wrap{max-width:980px;margin:12px auto}
    .card{background:#0f2431;padding:16px;border-radius:8px;margin-bottom:12px}
    input,textarea{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #284a5b;background:#071b26;color:#e6eef8}
    button{background:#00aaff;color:#001; border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .small{font-size:13px;color:#9fb4c9}
    .posts-list{display:grid;gap:10px}
    .post-row{display:flex;gap:8px;align-items:center;justify-content:space-between;background:#06202a;padding:10px;border-radius:6px}
    .actions button{margin-left:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Vision 3.0 — Admin Panel</h2>

    <div id="auth-section" class="card">
      <h3 id="auth-title">Login or Sign up</h3>
      <div id="user-info" style="display:none">
        <div class="small">Signed in as: <span id="user-email"></span></div>
        <button id="btn-logout">Logout</button>
      </div>

      <div id="auth-forms">
        <input id="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btn-login">Login</button>
          <button id="btn-signup">Sign up</button>
        </div>
        <div class="small" style="margin-top:8px">Only verified admin UID (in Firestore rules) can write posts.</div>
      </div>
    </div>

    <div id="admin-ui" style="display:none">
      <div class="card">
        <h3>Add / Edit Post</h3>
        <input id="post-title" placeholder="Post title" />
        <input id="post-image" placeholder="Image URL (optional)" />
        <input id="post-excerpt" placeholder="Short excerpt (optional)" />
        <textarea id="post-content" rows="6" placeholder="Full content (HTML allowed)"></textarea>
        <div style="margin-top:8px"><button id="btn-save">Save Post</button> <button id="btn-clear">Clear</button></div>
      </div>

      <div class="card">
        <h3>Existing Posts</h3>
        <div class="posts-list" id="posts-list">Loading...</div>
      </div>
    </div>

    <div id="log" class="card small"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== REPLACE WITH YOUR FIREBASE CONFIG ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    // ==============================================
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnLogin = document.getElementById('btn-login');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogout = document.getElementById('btn-logout');
    const authTitle = document.getElementById('auth-title');
    const userInfo = document.getElementById('user-info');
    const userEmailEl = document.getElementById('user-email');
    const adminUi = document.getElementById('admin-ui');
    const logEl = document.getElementById('log');

    const postTitle = document.getElementById('post-title');
    const postImage = document.getElementById('post-image');
    const postExcerpt = document.getElementById('post-excerpt');
    const postContent = document.getElementById('post-content');
    const btnSave = document.getElementById('btn-save');
    const postsList = document.getElementById('posts-list');

    let editId = null;
    let currentUser = null;

    function log(msg){ logEl.textContent = msg; }

    // auth listeners
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if(user){
        userInfo.style.display = '';
        userEmailEl.textContent = user.email;
        document.getElementById('auth-forms').style.display = 'none';
        authTitle.textContent = 'Admin';
        // show admin UI only after we confirm UID allowed (client-side check)
        // IMPORTANT: Firestore rules must enforce writes; client-side is convenience only.
        checkIfAdminAndShow(user.uid);
      } else {
        userInfo.style.display = 'none';
        document.getElementById('auth-forms').style.display = '';
        authTitle.textContent = 'Login or Sign up';
        adminUi.style.display = 'none';
      }
    });

    btnSignup.onclick = () => {
      const email = emailEl.value.trim(), pw = passEl.value.trim();
      if(!email || !pw) { log('Enter email & password'); return; }
      auth.createUserWithEmailAndPassword(email,pw)
        .then(()=> log('Signup success. Please verify email from your inbox.'))
        .catch(e=> log(e.message));
    };

    btnLogin.onclick = () => {
      const email = emailEl.value.trim(), pw = passEl.value.trim();
      if(!email || !pw) { log('Enter email & password'); return; }
      auth.signInWithEmailAndPassword(email,pw)
        .then(()=> log('Login success'))
        .catch(e=> log(e.message));
    };

    btnLogout.onclick = ()=> auth.signOut().then(()=> log('Signed out'));

    // check if user is admin by comparing UID with allowed list (client-side convenience)
    // YOU MUST set Firestore rules to allow writes only to admin UID(s)
    const ALLOWED_ADMIN_UIDS = ["YOUR_ADMIN_UID"]; // <-- replace with UID(s)

    function checkIfAdminAndShow(uid){
      if(ALLOWED_ADMIN_UIDS.includes(uid)){
        adminUi.style.display = '';
        loadPostsList(); // load posts to edit/delete
      } else {
        adminUi.style.display = 'none';
        log('Your account is not set as admin (client-side). Ensure Firestore rules include your UID.');
      }
    }

    // Save post (create or update)
    btnSave.onclick = async () => {
      const title = postTitle.value.trim();
      if(!title){ log('Title required'); return; }
      const data = {
        title,
        imageUrl: postImage.value.trim() || null,
        excerpt: postExcerpt.value.trim() || null,
        content: postContent.value.trim() || null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      try {
        if(editId){
          await db.collection('posts').doc(editId).update(data);
          log('Post updated');
        } else {
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('posts').add(data);
          log('Post created');
        }
        clearForm();
      } catch(e){
        log('Error saving post: ' + e.message);
      }
    };

    function clearForm(){ postTitle.value=''; postImage.value=''; postExcerpt.value=''; postContent.value=''; editId=null; }

    // load posts for admin list
    function loadPostsList(){
      postsList.innerHTML = 'Loading...';
      db.collection('posts').orderBy('createdAt','desc').get()
        .then(snap=>{
          postsList.innerHTML = '';
          if(snap.empty){ postsList.innerHTML = '<div class="small">No posts yet</div>'; return; }
          snap.forEach(doc=>{
            const d = doc.data();
            const row = document.createElement('div'); row.className='post-row';
            const left = document.createElement('div');
            left.innerHTML = `<strong>${escapeHtml(d.title||'Untitled')}</strong><div class="small">${d.excerpt||''}</div>`;
            const actions = document.createElement('div'); actions.className='actions';
            const btnEdit = document.createElement('button'); btnEdit.textContent='Edit';
            btnEdit.onclick = ()=> { editId = doc.id; postTitle.value = d.title||''; postImage.value = d.imageUrl||''; postExcerpt.value = d.excerpt||''; postContent.value = d.content||''; window.scrollTo(0,0); };
            const btnDelete = document.createElement('button'); btnDelete.textContent='Delete';
            btnDelete.onclick = async ()=> {
              if(!confirm('Delete this post?')) return;
              try { await db.collection('posts').doc(doc.id).delete(); log('Deleted'); loadPostsList(); } catch(e){ log('Delete failed: '+e.message); }
            };
            actions.appendChild(btnEdit); actions.appendChild(btnDelete);
            row.appendChild(left); row.appendChild(actions);
            postsList.appendChild(row);
          });
        })
        .catch(e=> postsList.innerHTML='Error: '+e.message);
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
